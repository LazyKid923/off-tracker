
<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial, sans-serif; margin: 16px; color: #1f2937; }
      h3 { margin: 0 0 12px 0; }
      label { display: block; font-weight: 600; margin-top: 10px; margin-bottom: 4px; }
      input, select, textarea { width: 100%; box-sizing: border-box; padding: 8px; }
      .off-list { min-height: 220px; max-height: 260px; overflow: auto; border: 1px solid #9ca3af; padding: 8px; border-radius: 4px; background: #fff; }
      .off-item { display: block; margin: 4px 0; line-height: 1.35; }
      .off-item input { width: auto; margin-right: 8px; vertical-align: middle; }
      .off-empty { color: #6b7280; }
      textarea { min-height: 80px; resize: vertical; }
      .actions { margin-top: 14px; display: flex; gap: 8px; }
      button { padding: 8px 12px; cursor: pointer; }
      .error { margin-top: 10px; color: #b91c1c; white-space: pre-wrap; }
      .hint { margin-top: 8px; color: #374151; font-size: 12px; white-space: pre-wrap; }
      .trace-label { margin-top: 8px; font-weight: 600; font-size: 12px; color: #111827; }
      .trace { margin-top: 4px; min-height: 80px; max-height: 160px; overflow: auto; background: #f9fafb; border: 1px solid #d1d5db; padding: 8px; font-size: 11px; white-space: pre-wrap; color: #111827; }
    </style>
  </head>
  <body>
    <h3>Use Off Day</h3>

    <label for="intendedDate">Enter date intended to use Off</label>
    <input id="intendedDate" type="date" />

    <label for="session">Session</label>
    <select id="session">
      <option value="FULL">Full Day (1)</option>
      <option value="AM">AM (0.5)</option>
      <option value="PM">PM (0.5)</option>
    </select>

    <label for="offIds">Which OFF ID number do you want to use?</label>
    <div id="offIdsList" class="off-list">
      <label class="off-item"><input class="off-id-checkbox" type="checkbox" name="offIds" value="G-0001" data-remaining="0.5"> G-0001, 0.5 day, Weekend Ops on (2026-02-28)</label>
<label class="off-item"><input class="off-id-checkbox" type="checkbox" name="offIds" value="G-0002" data-remaining="0.5"> G-0002, 0.5 day, Weekend Ops on (2026-02-21)</label>
    </div>
    <div class="hint">Tick one or more OFF IDs.</div>
    <div class="hint">Server preloaded OFF IDs: 2</div>

    <div id="selectionHint" class="hint"></div>
    <div id="debugInfo" class="hint">Debug: rowsScanned=2, rowsWithId=2, rowsWithRemaining=2, optionsGenerated=2, parseErrors=0</div>
    <div class="trace-label">Trace Log</div>
    <pre id="trace" class="trace">If this stays empty, dialog JavaScript is not running.</pre>

    <label for="comments">Comments (optional)</label>
    <textarea id="comments" placeholder="Add comments..."></textarea>

    <div class="actions">
      <button id="submitBtn" type="button" onclick="submitForm()">Submit</button>
      <button id="cancelBtn" type="button" onclick="if(window.google&&google.script&&google.script.host){google.script.host.close();}">Cancel</button>
    </div>

    <div id="error" class="error"></div>

    <script>
      function todayYmd() {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return yyyy + '-' + mm + '-' + dd;
      }

      function setError(message) {
        document.getElementById('error').textContent = message || '';
      }

      function trace(message) {
        const el = document.getElementById('trace');
        if (!el) return;
        if (el.textContent === 'If this stays empty, dialog JavaScript is not running.') {
          el.textContent = '';
        }
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        const ss = String(now.getSeconds()).padStart(2, '0');
        el.textContent += '[' + hh + ':' + mm + ':' + ss + '] ' + message + '\n';
        el.scrollTop = el.scrollHeight;
      }

      function setSubmitting(isSubmitting) {
        const btn = document.getElementById('submitBtn');
        if (!btn) return;
        btn.disabled = isSubmitting;
        btn.textContent = isSubmitting ? 'Submitting...' : 'Submit';
      }

      function getSelectedOptions() {
        return Array.from(document.querySelectorAll('.off-id-checkbox:checked'));
      }

      function updateSelectionHint() {
        const session = document.getElementById('session').value;
        const needed = session === 'FULL' ? 1 : 0.5;

        const selected = getSelectedOptions();
        let total = 0;
        for (const opt of selected) {
          total += Number(opt.dataset.remaining || 0);
        }

        const hint = document.getElementById('selectionHint');
        const totalText = Number.isInteger(total) ? String(total) : total.toFixed(1);
        const neededText = Number.isInteger(needed) ? String(needed) : needed.toFixed(1);

        let message = 'Selected total: ' + totalText + ' day\nRequired: ' + neededText + ' day';
        if (total < needed) {
          message += '
Choose another ID to meet required total.';
        }

        hint.textContent = message;
      }

      function submitForm() {
        trace('Submit clicked');
        setError('');
        setSubmitting(true);

        const selectedIds = getSelectedOptions().map((opt) => opt.value);
        if (selectedIds.length === 0) {
          setError('Please choose at least one OFF ID.');
          trace('Validation failed: no OFF ID selected');
          setSubmitting(false);
          return;
        }

        const payload = {
          intendedDate: document.getElementById('intendedDate').value,
          session: document.getElementById('session').value,
          selectedIds,
          comments: document.getElementById('comments').value
        };
        trace('Payload: ' + JSON.stringify(payload));

        if (!(window.google && google.script && google.script.run)) {
          setError('Apps Script runtime unavailable in dialog.');
          trace('google.script.run is unavailable');
          setSubmitting(false);
          return;
        }

        google.script.run
          .withFailureHandler((err) => {
            const msg = err && err.message ? err.message : String(err);
            setError(msg);
            trace('submitUseOffDay failure: ' + msg);
            setSubmitting(false);
          })
          .withSuccessHandler((result) => {
            trace('submitUseOffDay success: ' + JSON.stringify(result));
            if (!result || !result.ok) {
              setError(result && result.message ? result.message : 'Failed to use off day.');
              setSubmitting(false);
              return;
            }
            alert(result.message || 'Recorded.');
            setSubmitting(false);
            google.script.host.close();
          })
          .submitUseOffDay(payload);
      }

      document.getElementById('intendedDate').value = todayYmd();
      trace('Dialog initialized');
      window.addEventListener('error', function (evt) {
        setError('Client script error: ' + (evt && evt.message ? evt.message : String(evt)));
        trace('Window error: ' + (evt && evt.message ? evt.message : String(evt)));
      });
      window.addEventListener('unhandledrejection', function (evt) {
        const reason = evt && evt.reason ? evt.reason : 'unknown';
        setError('Promise error: ' + reason);
        trace('Unhandled rejection: ' + reason);
      });
      const hasNoOptions = document.querySelectorAll('.off-id-checkbox').length === 0;
      if (hasNoOptions) {
        setError('No available OFF IDs in Offs (Granted).');
        trace('No checkbox options found');
      } else {
        setError('');
        trace('Checkbox options found: ' + document.querySelectorAll('.off-id-checkbox').length);
      }
      try {
        document.getElementById('session').addEventListener('change', updateSelectionHint);
        Array.from(document.querySelectorAll('.off-id-checkbox')).forEach(function (cb) {
          cb.addEventListener('change', updateSelectionHint);
        });
        document.getElementById('submitBtn').addEventListener('click', submitForm);
        document.getElementById('cancelBtn').addEventListener('click', function () {
          if (window.google && google.script && google.script.host) {
            google.script.host.close();
          }
        });
        trace('Event listeners bound');
      } catch (e) {
        trace('Listener binding error: ' + (e && e.message ? e.message : String(e)));
      }
      updateSelectionHint();
      trace('Selection hint updated');

      if (window.google && google.script && google.script.run) {
        google.script.run
          .withFailureHandler((err) => {
            const msg = err && err.message ? err.message : String(err);
            trace('pingUseOffDialog failure: ' + msg);
          })
          .withSuccessHandler((res) => {
            trace('pingUseOffDialog success: ' + JSON.stringify(res));
          })
          .pingUseOffDialog_();
      } else {
        trace('ping skipped: google.script.run unavailable');
      }
    </script>
  </body>
</html>